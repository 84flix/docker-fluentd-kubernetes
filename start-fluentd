#!/bin/sh

ELASTICSEARCH_SERVICE_NAME=$(echo "${ELASTICSEARCH_SERVICE_NAME:-ELASTICSEARCH}" | awk '{print toupper($0)}')
SVC_HOST=${ELASTICSEARCH_SERVICE_NAME}_SERVICE_HOST
SVC_PORT=${ELASTICSEARCH_SERVICE_NAME}_SERVICE_PORT

mkdir /etc/fluent

cat << 'EOF' > /etc/fluent/fluent.conf
<source>
  type tail
  path /var/lib/docker/containers/*/*-json.log
  pos_file /etc/fluent/fluentd-docker.pos
  time_format %Y-%m-%dT%H:%M:%S
  tag docker.*
  format json
</source>

<match docker.var.lib.docker.containers.*.*.log>
  type kubernetes
  container_id ${tag_parts[5]}
  tag docker.${name}
</match>

<match kubernetes>
  type elasticsearch
  logstash_format true
  reload_connections false
  time_key time
EOF

cat << EOF >> /etc/fluent/fluent.conf
  host $(eval echo \$${SVC_HOST})
  port $(eval echo \$${SVC_PORT})
EOF

cat << 'EOF' >> /etc/fluent/fluent.conf
</match>
EOF

exec fluentd
